
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password_hash String
  full_name     String?
  phone         String?
  created_at    DateTime @default(now())
  orders        Order[]
}

model Category {
  id        String     @id @default(cuid())
  name      String
  slug      String     @unique
  description String?
  
  // Скалярное поле — внешний ключ
  parent_id String?   // ← просто поле, без @relation!

  // Связь "родитель"
  parent    Category?  @relation("CategoryParent", fields: [parent_id], references: [id])

  // Связь "потомки"
  children  Category[] @relation("CategoryParent")

  products  Product[]
}

model Product {
  id          String   @id @default(cuid())
  sku         String   @unique
  name        String
  slug        String   @unique
  description String?
  price       Float
  in_stock    Boolean  @default(true)
  images      String[]
  attributes  Json?

  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Скалярное поле
  category_id String

  // Связь
  category    Category @relation(fields: [category_id], references: [id])

  orderItems  OrderItem[]
}

model Order {
  id                      String    @id @default(cuid())
  user_id                 String?   
  user                    User?     @relation(fields: [user_id], references: [id])
  status                  String    @default("new")
  customer_name           String
  customer_phone          String
  customer_email          String
  
  // Связь с DeliveryZone
  delivery_zone_id        String
  deliveryZone            DeliveryZone @relation(fields: [delivery_zone_id], references: [id])
  
  delivery_address        String?
  delivery_estimated_date DateTime?
  total_amount            Float
  created_at              DateTime @default(now())
  orderItems              OrderItem[]
}

model DeliveryZone {
  id                  String   @id @default(cuid())
  city_name           String   @unique
  delivery_days_min   Int
  delivery_days_max   Int
  is_active           Boolean  @default(true)
  created_at          DateTime @default(now())
  orders              Order[]  // ← обратная связь
}

model OrderItem {
  id         String   @id @default(cuid())
  
  // Скалярные поля
  order_id   String
  product_id String

  // Связи
  order      Order    @relation(fields: [order_id], references: [id])
  product    Product  @relation(fields: [product_id], references: [id])

  quantity   Int
  unit_price Float
  created_at DateTime @default(now())
}
